<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marcador Billar - Pepos</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
/* ===== TUS ESTILOS Y ANIMACIONES ORIGINALES ===== */
#loginOverlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #0a2e1a;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    flex-direction: column;
}
.loginBox {
    background: rgba(0,0,0,0.8);
    padding: 30px;
    border-radius: 15px;
    border: 2px solid #D4AF37;
    text-align: center;
}
.loginBox h2 { color: #D4AF37; margin-bottom: 20px; }
.loginBox input { 
    padding: 10px; font-size: 18px; border-radius: 5px; border: none; text-align: center; margin-bottom: 15px;
}

body{
margin:0;
font-family:Arial, Helvetica, sans-serif;
color:white;
background-image:url("/IMAGEN/Pepos.jpg");
background-size:cover;
background-position:center;
background-attachment:fixed;
}

.contenedor{
text-align:center;
background:rgba(0,0,0,0.75);
min-height:100vh;
padding:20px;
display: none; 
}

.titulo{
color:#D4AF37;
font-size:40px;
}

.mesaEditable{
font-size:28px;
color:#FFD700;
background:transparent;
border:none;
border-bottom:2px solid #D4AF37;
text-align:center;
width:120px;
outline:none;
}

.marcador{
display:flex;
justify-content:center;
align-items:center;
gap:40px;
flex-wrap:wrap;
margin-top:20px;
}

.jugador{
background:rgba(0,0,0,0.6);
padding:20px;
border-radius:12px;
}

.jugador input{
font-size:20px;
text-align:center;
padding:5px;
border:none;
border-radius:6px;
margin-bottom:10px;
}

.puntos{
font-size:80px;
color:#D4AF37;
}

button{
font-size:18px;
padding:10px 20px;
margin:5px;
border:none;
border-radius:8px;
cursor:pointer;
background:#D4AF37;
color:black;
font-weight:bold;
}

.vs{ font-size:30px; }
.panel{ margin-top:20px; }
.seccion{ margin-top:20px; font-size:18px; }

#contenedorQR {
    background: white;
    padding: 10px;
    display: inline-block;
    margin-top: 20px;
    border-radius: 8px;
}

.celebracion{
position:fixed;
top:0; left:0; width:100%; height:100%;
background:radial-gradient(circle, rgba(0,0,0,0.85), black);
display:none;
justify-content:center;
align-items:center;
flex-direction:column;
font-size:48px;
color:#FFD700;
z-index:999;
text-shadow:0 0 20px gold;
}

.celebracion.activa{
display:flex;
animation:aparecer 0.6s ease, brillo 2s infinite alternate;
}

@keyframes aparecer{ from{transform:scale(0.3); opacity:0} to{transform:scale(1); opacity:1} }
@keyframes brillo{ from{text-shadow:0 0 10px gold,0 0 20px gold} to{text-shadow:0 0 30px #FFD700,0 0 60px #FFD700} }
@keyframes rebote{ from{transform:translateY(0)} to{transform:translateY(-15px)} }
</style>
</head>

<body>

<div id="loginOverlay">
    <div class="loginBox">
        <h2>BILLARES PEPO</h2>
        <input type="password" id="passInput" placeholder="ContraseÃ±a">
        <br>
        <button onclick="validar()">Entrar</button>
    </div>
</div>

<div id="app" class="contenedor">
    <h1 class="titulo">BILLARES PEPO</h1>
    <h2>MESA <input id="mesaInput" class="mesaEditable"></h2>

    <div class="marcador">
        <div class="jugador">
            <input id="nombreA" value="Jugador 1">
            <div class="puntos" id="puntosA">0</div>
            <button onclick="sumarA()">+ Punto</button>
            <button onclick="restarA()">- Punto</button>
        </div>
        <div class="vs">VS</div>
        <div class="jugador">
            <input id="nombreB" value="Jugador 2">
            <div class="puntos" id="puntosB">0</div>
            <button onclick="sumarB()">+ Punto</button>
            <button onclick="restarB()">- Punto</button>
        </div>
    </div>

    <div class="panel">
        Objetivo: <input id="objetivo" type="number" value="40">
        <button onclick="resetear()">Reiniciar marcador</button>
    </div>

    <div class="seccion">
        <div id="contenedorQR"></div>
        <p style="font-size: 14px; color: #D4AF37;">Escanea para controlar desde el celular</p>
    </div>

    <div class="seccion">
        <h3>ðŸ“Š Ranking</h3>
        <div id="ranking"></div>
    </div>
    <div class="seccion">
        <h3>ðŸ“ˆ EstadÃ­sticas</h3>
        <div id="estadisticas"></div>
    </div>
</div>

<div class="celebracion" id="celebracion">
    <div id="textoGanador" style="animation:rebote 0.7s infinite alternate;"></div>
    <br>
    <button onclick="nuevaPartida()">Nueva partida</button>
</div>

<script>
// CONFIGURACIÃ“N FIREBASE CON TU URL
const firebaseConfig = { databaseURL: "https://billares-pepo-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let puntosA = 0, puntosB = 0;
let ranking = {};
let estadisticas = {};

// LOGIN
function validar() {
    if(document.getElementById('passInput').value === 'billar2025') {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        setTimeout(inicializarQR, 300);
        
        // Cargar datos histÃ³ricos de Firebase al entrar
        db.ref('datos_jugadores').on('value', (snapshot) => {
            const data = snapshot.val();
            if(data) {
                ranking = data.ranking || {};
                estadisticas = data.estadisticas || {};
                renderDatos();
            }
        });

        // Escuchar puntos en tiempo real
        db.ref('marcador').on('value', (snapshot) => {
            const data = snapshot.val();
            if(data) {
                puntosA = data.pA;
                puntosB = data.pB;
                actualizar();
                verificar();
            }
        });
    } else { alert("ContraseÃ±a incorrecta"); }
}

function enviarPuntos() {
    db.ref('marcador').set({ pA: puntosA, pB: puntosB });
}

function actualizar() {
    document.getElementById("puntosA").textContent = puntosA;
    document.getElementById("puntosB").textContent = puntosB;
}

function sumarA() { puntosA++; enviarPuntos(); }
function restarA() { if(puntosA>0) puntosA--; enviarPuntos(); }
function sumarB() { puntosB++; enviarPuntos(); }
function restarB() { if(puntosB>0) puntosB--; enviarPuntos(); }

function verificar() {
    let obj = parseInt(document.getElementById("objetivo").value);
    if(puntosA >= obj) registrarVictoria(document.getElementById('nombreA').value, document.getElementById('nombreB').value, puntosA, puntosB);
    else if(puntosB >= obj) registrarVictoria(document.getElementById('nombreB').value, document.getElementById('nombreA').value, puntosB, puntosA);
}

function registrarVictoria(ganador, perdedor, pG, pP) {
    // Evitar registros dobles si ya se activÃ³ la celebraciÃ³n
    if(document.getElementById("celebracion").classList.contains("activa")) return;

    ranking[ganador] = (ranking[ganador] || 0) + 1;
    if(!estadisticas[ganador]) estadisticas[ganador] = {jugadas:0, puntos:0};
    if(!estadisticas[perdedor]) estadisticas[perdedor] = {jugadas:0, puntos:0};
    
    estadisticas[ganador].jugadas++;
    estadisticas[ganador].puntos += pG;
    estadisticas[perdedor].jugadas++;
    estadisticas[perdedor].puntos += pP;
    
    // Guardar Ranking y EstadÃ­sticas en Firebase
    db.ref('datos_jugadores').set({
        ranking: ranking,
        estadisticas: estadisticas
    });
    
    document.getElementById("textoGanador").textContent = "ðŸ† GANADOR: " + ganador;
    document.getElementById("celebracion").classList.add("activa");
    lanzarConfeti();
}

function renderDatos() {
    let r = "";
    Object.entries(ranking).sort((a,b)=>b[1]-a[1]).forEach(([n,v],i)=> r+=`${i+1}. ${n} â€” ${v} vict.<br>`);
    document.getElementById("ranking").innerHTML = r;
    
    let e = "";
    for(let j in estadisticas) {
        let s = estadisticas[j];
        let prom = s.jugadas > 0 ? (s.puntos/s.jugadas).toFixed(1) : 0;
        e += `${j}: Partidas ${s.jugadas} | Promedio ${prom}<br>`;
    }
    document.getElementById("estadisticas").innerHTML = e;
}

function nuevaPartida() {
    document.getElementById("celebracion").classList.remove("activa");
    resetear();
}

function resetear() {
    puntosA = 0; puntosB = 0;
    enviarPuntos();
}

function inicializarQR() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('modo') === 'remoto') {
        document.getElementById('app').style.display = 'block';
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('app').innerHTML = `
            <div style="padding:20px;">
                <h1 class="titulo">CONTROL PEPO</h1>
                <button onclick="remote(1,0)" style="width:100%; height:120px; font-size:40px; background:#D4AF37; margin-bottom:10px; border-radius:15px;">+ J1</button>
                <button onclick="remote(0,1)" style="width:100%; height:120px; font-size:40px; background:#D4AF37; border-radius:15px;">+ J2</button>
                <button onclick="remote(-1,0)" style="width:48%; height:60px; background:#555; color:white; margin-top:20px; border-radius:10px;">- J1</button>
                <button onclick="remote(0,-1)" style="width:48%; height:60px; background:#555; color:white; margin-top:20px; border-radius:10px;">- J2</button>
            </div>`;
        
        window.remote = (a, b) => {
            db.ref('marcador').once('value', s => {
                const d = s.val() || {pA:0, pB:0};
                db.ref('marcador').set({ 
                    pA: Math.max(0, d.pA + a), 
                    pB: Math.max(0, d.pB + b) 
                });
            });
        };
    } else {
        const qrDiv = document.getElementById("contenedorQR");
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, {
            text: window.location.href.split('?')[0] + "?modo=remoto",
            width: 150, height: 150
        });
    }
}

function lanzarConfeti(){
    for(let i=0;i<40;i++){
        let c=document.createElement("div");
        c.style.position="fixed"; c.style.left=Math.random()*100+"%"; c.style.top="-10px";
        c.style.width="8px"; c.style.height="8px"; c.style.background="gold"; c.style.borderRadius="50%";
        document.body.appendChild(c);
        c.animate([{transform:"translateY(0)"},{transform:"translateY(100vh)"}],{duration:2000});
        setTimeout(()=>c.remove(),2000);
    }
}
</script>
</body>
</html>
