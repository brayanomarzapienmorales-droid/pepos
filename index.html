<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marcador Billar - Pepos Premium</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
/* ===== ESTILOS PREMIUM ===== */
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    color: white;
    /* RUTA DE TU IMAGEN DESCARGADA */
    background-image: url("/IMAGEN/Pepos.jpg"); 
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    background-color: #111;
}

/* Efecto Vidrio Esmerilado (Glassmorphism) */
.glass-effect {
    background: rgba(15, 15, 15, 0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(212, 175, 55, 0.2);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
}

#loginOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
    display: flex; justify-content: center; align-items: center;
    z-index: 9999; flex-direction: column;
}

.loginBox {
    padding: 40px; border-radius: 20px; text-align: center;
}
.loginBox h2 { color: #FFD700; margin-bottom: 25px; font-weight: 800; letter-spacing: 2px; text-shadow: 0 0 10px rgba(255,215,0,0.3); }
.loginBox input { 
    padding: 15px; font-size: 18px; border-radius: 10px; border: 1px solid rgba(255,215,0,0.3); 
    text-align: center; margin-bottom: 20px; background: rgba(255,255,255,0.1); color: white;
    font-family: 'Poppins', sans-serif; outline: none; transition: all 0.3s;
}
.loginBox input:focus { border-color: #FFD700; box-shadow: 0 0 15px rgba(255,215,0,0.2); }

.contenedor {
    text-align: center; min-height: 100vh; padding: 30px 20px; display: none; 
}

.titulo { color: #FFD700; font-size: 45px; font-weight: 800; text-shadow: 0 5px 15px rgba(0,0,0,0.8); margin-bottom: 5px; }

.mesaEditable {
    font-size: 28px; color: #fff; background: transparent; border: none;
    border-bottom: 2px dashed #D4AF37; text-align: center; width: 80px;
    outline: none; font-family: 'Poppins', sans-serif; font-weight: 600;
    transition: all 0.3s;
}
.mesaEditable:focus { border-bottom-style: solid; color: #FFD700; }

.marcador {
    display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap; margin-top: 30px;
}

.jugador {
    padding: 30px; border-radius: 20px; min-width: 250px;
    transition: transform 0.3s;
}
.jugador:hover { transform: translateY(-5px); }

.jugador input {
    font-size: 24px; text-align: center; padding: 10px; border: none; border-bottom: 2px solid transparent;
    background: transparent; color: white; font-weight: 600; margin-bottom: 15px;
    font-family: 'Poppins', sans-serif; transition: all 0.3s; width: 90%;
}
.jugador input:focus { border-bottom: 2px solid #D4AF37; outline: none; }

/* Animaci√≥n de los puntos al cambiar */
.puntos {
    font-size: 90px; color: #FFD700; font-weight: 800; text-shadow: 0 5px 15px rgba(0,0,0,0.5);
    margin: 10px 0 20px 0; display: inline-block;
}
@keyframes popEffect {
    0% { transform: scale(1); text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    50% { transform: scale(1.3); color: #FFF; text-shadow: 0 0 30px #FFD700; }
    100% { transform: scale(1); text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
}
.animar-punto { animation: popEffect 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

/* Botones con efectos suaves */
button {
    font-size: 16px; padding: 12px 25px; margin: 5px; border: none; border-radius: 10px;
    cursor: pointer; background: linear-gradient(135deg, #FFDF00 0%, #D4AF37 100%);
    color: #111; font-weight: 800; font-family: 'Poppins', sans-serif;
    text-transform: uppercase; letter-spacing: 1px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.2s ease;
}
button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4); filter: brightness(1.1); }
button:active { transform: translateY(1px); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
button.restar { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
button.restar:hover { background: rgba(255,255,255,0.2); box-shadow: 0 6px 20px rgba(255,255,255,0.1); }

.vs { font-size: 35px; font-weight: 800; color: rgba(255,255,255,0.5); text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

.panel, .seccion { margin-top: 40px; padding: 20px; border-radius: 20px; }
.panel input { padding: 8px; border-radius: 8px; border: none; text-align: center; font-size: 18px; width: 60px; font-weight: bold;}

#contenedorQR { background: white; padding: 15px; display: inline-block; margin-top: 10px; border-radius: 12px; }

.celebracion {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: none;
    justify-content: center; align-items: center; flex-direction: column; z-index: 9999;
}
.celebracion.activa { display: flex; animation: fadeIntro 0.5s ease; }
@keyframes fadeIntro { from { opacity: 0; } to { opacity: 1; } }
@keyframes reboteTexto { 0% { transform: scale(1); } 50% { transform: scale(1.1); text-shadow: 0 0 40px #FFD700; } 100% { transform: scale(1); } }
#textoGanador { font-size: 60px; font-weight: 800; color: #FFD700; text-align: center; text-shadow: 0 0 20px gold; animation: reboteTexto 1.5s infinite alternate ease-in-out; margin-bottom: 30px;}

</style>
</head>

<body>

<div id="loginOverlay">
    <div class="loginBox glass-effect">
        <h2>BILLARES PEPO</h2>
        <input type="password" id="passInput" placeholder="Contrase√±a secreta...">
        <br>
        <button onclick="validar()">ENTRAR AL TORNEO</button>
    </div>
</div>

<div id="app" class="contenedor">
    <div class="glass-effect" style="padding: 20px; border-radius: 20px; margin-bottom: 20px;">
        <h1 class="titulo">BILLARES PEPO</h1>
        <h2 style="font-weight: 400;">MESA <input id="mesaInput" class="mesaEditable"></h2>
    </div>

    <div class="marcador">
        <div class="jugador glass-effect">
            <input id="nombreA" value="Jugador 1">
            <div class="puntos" id="puntosA">0</div><br>
            <button onclick="sumarA()">+ PUNTOS</button>
            <button class="restar" onclick="restarA()">- Quitar</button>
        </div>
        
        <div class="vs">VS</div>
        
        <div class="jugador glass-effect">
            <input id="nombreB" value="Jugador 2">
            <div class="puntos" id="puntosB">0</div><br>
            <button onclick="sumarB()">+ PUNTOS</button>
            <button class="restar" onclick="restarB()">- Quitar</button>
        </div>
    </div>

    <div class="panel glass-effect">
        <span style="font-size: 20px; font-weight: 600; margin-right: 15px;">Puntos para ganar:</span>
        <input id="objetivo" type="number" value="40">
        <button onclick="resetear()" style="margin-left: 20px; background: #e74c3c; color: white;">Reiniciar Partida</button>
    </div>

    <div class="seccion glass-effect" style="display: flex; flex-direction: column; align-items: center;">
        <h3 style="color: #FFD700;">üì± Modo Remoto</h3>
        <p style="font-size: 14px; opacity: 0.8;">Escanea con tu celular para controlar el marcador de esta mesa a distancia.</p>
        <div id="contenedorQR"></div>
    </div>

    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
        <div class="seccion glass-effect" style="flex: 1; min-width: 300px;">
            <h3 style="color: #FFD700; border-bottom: 1px solid rgba(255,215,0,0.3); padding-bottom: 10px;">üèÜ Top Ranking</h3>
            <div id="ranking" style="text-align: left; padding-left: 20px; line-height: 1.8;"></div>
        </div>
        <div class="seccion glass-effect" style="flex: 1; min-width: 300px;">
            <h3 style="color: #FFD700; border-bottom: 1px solid rgba(255,215,0,0.3); padding-bottom: 10px;">üìà Estad√≠sticas Jugadores</h3>
            <div id="estadisticas" style="text-align: left; padding-left: 20px; line-height: 1.8;"></div>
        </div>
    </div>
</div>

<div class="celebracion" id="celebracion">
    <div id="textoGanador"></div>
    <button onclick="nuevaPartida()" style="font-size: 24px; padding: 15px 40px; border-radius: 50px;">NUEVA PARTIDA</button>
</div>

<script>
// CONFIGURACI√ìN FIREBASE CON TU URL OFICIAL
const firebaseConfig = { databaseURL: "https://billares-pepo-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let puntosA = 0, puntosB = 0;
let ranking = {};
let estadisticas = {};

// LOGIN
function validar() {
    if(document.getElementById('passInput').value === 'billar2025') {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        setTimeout(inicializarQR, 300);
        
        db.ref('datos_jugadores').on('value', (snapshot) => {
            const data = snapshot.val();
            if(data) {
                ranking = data.ranking || {};
                estadisticas = data.estadisticas || {};
                renderDatos();
            }
        });

        db.ref('marcador').on('value', (snapshot) => {
            const data = snapshot.val();
            if(data) {
                // Animar si cambiaron los puntos
                if(data.pA !== puntosA) animarNumero("puntosA");
                if(data.pB !== puntosB) animarNumero("puntosB");
                
                puntosA = data.pA;
                puntosB = data.pB;
                actualizarDOM();
                verificar();
            }
        });
    } else { alert("Contrase√±a incorrecta"); }
}

function enviarPuntos() {
    db.ref('marcador').set({ pA: puntosA, pB: puntosB });
}

function actualizarDOM() {
    document.getElementById("puntosA").textContent = puntosA;
    document.getElementById("puntosB").textContent = puntosB;
}

// Funci√≥n para el efecto Pop
function animarNumero(idElemento) {
    const el = document.getElementById(idElemento);
    el.classList.remove("animar-punto");
    void el.offsetWidth; // Reinicia la animaci√≥n
    el.classList.add("animar-punto");
}

function sumarA() { puntosA++; enviarPuntos(); }
function restarA() { if(puntosA>0) puntosA--; enviarPuntos(); }
function sumarB() { puntosB++; enviarPuntos(); }
function restarB() { if(puntosB>0) puntosB--; enviarPuntos(); }

function verificar() {
    let obj = parseInt(document.getElementById("objetivo").value);
    if(puntosA >= obj) registrarVictoria(document.getElementById('nombreA').value, document.getElementById('nombreB').value, puntosA, puntosB);
    else if(puntosB >= obj) registrarVictoria(document.getElementById('nombreB').value, document.getElementById('nombreA').value, puntosB, puntosA);
}

function registrarVictoria(ganador, perdedor, pG, pP) {
    if(document.getElementById("celebracion").classList.contains("activa")) return;

    ranking[ganador] = (ranking[ganador] || 0) + 1;
    if(!estadisticas[ganador]) estadisticas[ganador] = {jugadas:0, puntos:0};
    if(!estadisticas[perdedor]) estadisticas[perdedor] = {jugadas:0, puntos:0};
    
    estadisticas[ganador].jugadas++; estadisticas[ganador].puntos += pG;
    estadisticas[perdedor].jugadas++; estadisticas[perdedor].puntos += pP;
    
    db.ref('datos_jugadores').set({ ranking: ranking, estadisticas: estadisticas });
    
    document.getElementById("textoGanador").innerHTML = "¬°TENEMOS UN CAMPE√ìN!<br><span style='color:white; font-size: 80px;'>" + ganador + "</span>";
    document.getElementById("celebracion").classList.add("activa");
    lanzarConfetiProfesional();
}

function renderDatos() {
    let r = "";
    Object.entries(ranking).sort((a,b)=>b[1]-a[1]).forEach(([n,v],i)=> {
        let medalla = i===0 ? "ü•á" : i===1 ? "ü•à" : i===2 ? "ü•â" : "üî∏";
        r += `<b>${medalla} ${n}</b>: ${v} victorias<br>`;
    });
    document.getElementById("ranking").innerHTML = r;
    
    let e = "";
    for(let j in estadisticas) {
        let s = estadisticas[j];
        let prom = s.jugadas > 0 ? (s.puntos/s.jugadas).toFixed(1) : 0;
        e += `<b>${j}</b> ‚ûî Partidas: ${s.jugadas} | Eficiencia: ${prom} pts/partida<br>`;
    }
    document.getElementById("estadisticas").innerHTML = e;
}

function nuevaPartida() {
    document.getElementById("celebracion").classList.remove("activa");
    resetear();
}

function resetear() { puntosA = 0; puntosB = 0; enviarPuntos(); }

function inicializarQR() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('modo') === 'remoto') {
        document.body.style.backgroundImage = "none";
        document.body.style.backgroundColor = "#111";
        document.getElementById('app').style.display = 'block';
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('app').innerHTML = `
            <div style="padding:20px; max-width: 500px; margin: auto;">
                <h1 class="titulo" style="font-size: 35px; text-align: center;">MANDO A DISTANCIA</h1>
                <div class="glass-effect" style="padding: 20px; border-radius: 20px; margin-bottom: 20px;">
                    <h2 style="margin:0 0 15px 0;">JUGADOR 1</h2>
                    <button onclick="remote(1,0)" style="width:100%; height:100px; font-size:50px; border-radius:15px;">+</button>
                    <button class="restar" onclick="remote(-1,0)" style="width:100%; height:50px; margin-top:10px;">- Quitar Punto</button>
                </div>
                <div class="glass-effect" style="padding: 20px; border-radius: 20px;">
                    <h2 style="margin:0 0 15px 0;">JUGADOR 2</h2>
                    <button onclick="remote(0,1)" style="width:100%; height:100px; font-size:50px; border-radius:15px;">+</button>
                    <button class="restar" onclick="remote(0,-1)" style="width:100%; height:50px; margin-top:10px;">- Quitar Punto</button>
                </div>
            </div>`;
        
        window.remote = (a, b) => {
            if(window.navigator.vibrate) window.navigator.vibrate(50); // Vibraci√≥n h√°ptica en celulares
            db.ref('marcador').once('value', s => {
                const d = s.val() || {pA:0, pB:0};
                db.ref('marcador').set({ pA: Math.max(0, d.pA + a), pB: Math.max(0, d.pB + b) });
            });
        };
    } else {
        const qrDiv = document.getElementById("contenedorQR");
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { text: window.location.href.split('?')[0] + "?modo=remoto", width: 180, height: 180 });
    }
}

// CONFETI PROFESIONAL
function lanzarConfetiProfesional() {
    var duration = 4000;
    var animationEnd = Date.now() + duration;
    var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 10000 };

    function randomInRange(min, max) { return Math.random() * (max - min) + min; }

    var interval = setInterval(function() {
        var timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) return clearInterval(interval);
        var particleCount = 50 * (timeLeft / duration);
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
    }, 250);
}
</script>
</body>
</html>
