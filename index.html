<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Torneo Billares Pepo</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
/* ===== ESTILOS PARA PANTALLA √öNICA (NO SCROLL) ===== */
* { box-sizing: border-box; }

body {
    margin: 0; padding: 0; font-family: 'Poppins', sans-serif; color: white;
    background-image: url("./IMAGEN/Pepos.jpg"); 
    background-size: cover; background-position: center; background-attachment: fixed;
    background-color: #111; height: 100vh; overflow: hidden; 
}

.glass-effect {
    background: rgba(15, 15, 15, 0.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(212, 175, 55, 0.2); box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.5); border-radius: 15px;
}

#loginOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
    display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column;
}
.loginBox { padding: 40px; text-align: center; }
.loginBox h2 { color: #FFD700; margin-bottom: 25px; font-weight: 800; letter-spacing: 2px; }
.loginBox input { 
    padding: 15px; font-size: 18px; border-radius: 10px; border: 1px solid rgba(255,215,0,0.3); 
    text-align: center; margin-bottom: 20px; background: rgba(255,255,255,0.1); color: white;
    font-family: 'Poppins', sans-serif; outline: none; transition: all 0.3s;
}

.contenedor { display: none; flex-direction: column; justify-content: space-between; height: 100vh; padding: 1vh 1.5vw; gap: 1vh; }

.header-box { padding: 1vh; text-align: center; display: flex; flex-direction: column; align-items: center; }
.titulo { color: #FFD700; font-size: 3.5vh; font-weight: 800; text-shadow: 0 3px 10px rgba(0,0,0,0.8); margin: 0; }
.mesa-container { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
.mesaEditable {
    font-size: 2.5vh; color: #fff; background: transparent; border: none;
    border-bottom: 2px dashed #D4AF37; text-align: center; width: 80px;
    outline: none; font-family: 'Poppins', sans-serif; font-weight: 600;
}

#timer-display {
    font-size: 4vh; font-weight: 800; color: #FFD700; text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    margin-top: 0.5vh; font-variant-numeric: tabular-nums; letter-spacing: 2px;
}

.marcador { flex: 1; display: flex; justify-content: center; align-items: center; gap: 3vw; max-height: 45vh; }
.jugador { padding: 2vh 2vw; min-width: 25vw; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.jugador input {
    font-size: 3vh; text-align: center; padding: 5px; border: none; border-bottom: 2px solid transparent;
    background: transparent; color: white; font-weight: 600; margin-bottom: 0;
    font-family: 'Poppins', sans-serif; width: 100%; outline: none;
}
.puntos {
    font-size: 12vh; color: #FFD700; font-weight: 800; text-shadow: 0 5px 15px rgba(0,0,0,0.5);
    margin: 1vh 0; display: inline-block; line-height: 1;
}

@keyframes popEffect { 0% { transform: scale(1); } 50% { transform: scale(1.2); color: #FFF; text-shadow: 0 0 30px #FFD700; } 100% { transform: scale(1); } }
.animar-punto { animation: popEffect 0.3s ease-out; }

button {
    font-size: 1.8vh; padding: 1vh 2vw; margin: 3px; border: none; border-radius: 8px;
    cursor: pointer; background: linear-gradient(135deg, #FFDF00 0%, #D4AF37 100%);
    color: #111; font-weight: 800; font-family: 'Poppins', sans-serif; text-transform: uppercase; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.2s;
}
button:hover { transform: translateY(-2px); filter: brightness(1.1); }
button:active { transform: translateY(1px); }
button.restar { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }

.vs { font-size: 4vh; font-weight: 800; color: rgba(255,255,255,0.5); }

.bottom-row { display: flex; justify-content: space-between; align-items: stretch; gap: 1vw; height: 22vh; }
.bottom-box { flex: 1; padding: 1.5vh 1vw; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
.bottom-box::-webkit-scrollbar { width: 5px; }
.bottom-box::-webkit-scrollbar-thumb { background: rgba(212, 175, 55, 0.5); border-radius: 5px; }
.bottom-box h3 { color: #FFD700; margin: 0 0 1vh 0; font-size: 1.8vh; text-transform: uppercase; border-bottom: 1px solid rgba(255,215,0,0.3); padding-bottom: 5px; width: 100%; text-align: center;}
.config-box input { padding: 5px; border-radius: 5px; border: none; text-align: center; font-size: 2vh; width: 60px; font-weight: bold; margin: 5px 0 10px 0;}

#contenedorQR { background: white; padding: 10px; border-radius: 10px; display: flex; justify-content: center; align-items: center; }
#contenedorQR img { width: 8vh !important; height: 8vh !important; }

.celebracion {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: none;
    justify-content: center; align-items: center; flex-direction: column; z-index: 9999;
}
.celebracion.activa { display: flex; animation: fadeIntro 0.5s ease; }
@keyframes fadeIntro { from { opacity: 0; } to { opacity: 1; } }
@keyframes reboteTexto { 0% { transform: scale(1); } 50% { transform: scale(1.1); text-shadow: 0 0 40px #FFD700; } 100% { transform: scale(1); } }
#textoGanador { font-size: 8vh; font-weight: 800; color: #FFD700; text-align: center; text-shadow: 0 0 20px gold; animation: reboteTexto 1.5s infinite alternate ease-in-out; margin-bottom: 3vh;}

/* Ajustes Especiales para el Mando Remoto */
.btn-remoto { width:100%; height:12vh; font-size:5vh; border-radius:15px; display:flex; flex-direction:column; justify-content:center; align-items:center; line-height:1; }
.btn-remoto-restar { width:100%; height:7vh; font-size:2vh; margin-top:1vh; }

/* Nuevo campo de texto (Input) para el celular */
.nombre-input-remoto {
    width: 100%; font-size: 2.5vh; text-align: center; padding: 1vh;
    background: rgba(0,0,0,0.5); color: #FFD700; border: 1px solid rgba(212, 175, 55, 0.5);
    border-radius: 10px; margin-bottom: 1.5vh; font-family: 'Poppins', sans-serif; font-weight: bold;
    outline: none; transition: border 0.3s;
}
.nombre-input-remoto:focus { border-color: #FFF; background: rgba(0,0,0,0.8); }

</style>
</head>

<body>

<div id="loginOverlay">
    <div class="loginBox glass-effect">
        <h2>BILLARES PEPO</h2>
        <input type="password" id="passInput" placeholder="Contrase√±a secreta...">
        <br>
        <button onclick="iniciarSistema()" style="padding: 15px 30px; font-size: 16px;">ENTRAR AL TORNEO</button>
    </div>
</div>

<div id="app" class="contenedor">
    
    <div class="header-box glass-effect">
        <h1 class="titulo">BILLARES PEPO</h1>
        <div class="mesa-container">
            <h2 style="font-weight: 400; margin:0; font-size: 2vh;">MESA <input id="mesaInput" class="mesaEditable" onchange="cambiarMesa()"></h2>
        </div>
        <div id="timer-display">00:00:00</div>
    </div>

    <div class="marcador">
        <div class="jugador glass-effect">
            <input id="nombreA" value="Jugador 1" onchange="enviarEstado()">
            <div class="puntos" id="puntosA">0</div>
            <div style="display:flex; gap:5px; width: 100%;">
                <button onclick="sumarA()" style="flex:1;">+ PUNTO</button>
                <button class="restar" onclick="restarA()" style="flex:1;">- Quitar</button>
            </div>
        </div>
        
        <div class="vs">VS</div>
        
        <div class="jugador glass-effect">
            <input id="nombreB" value="Jugador 2" onchange="enviarEstado()">
            <div class="puntos" id="puntosB">0</div>
            <div style="display:flex; gap:5px; width: 100%;">
                <button onclick="sumarB()" style="flex:1;">+ PUNTO</button>
                <button class="restar" onclick="restarB()" style="flex:1;">- Quitar</button>
            </div>
        </div>
    </div>

    <div class="bottom-row">
        <div class="bottom-box glass-effect config-box">
            <h3>‚öôÔ∏è Opciones</h3>
            <span style="font-size: 1.5vh; opacity: 0.8;">Puntos para ganar:</span>
            <input id="objetivo" type="number" value="40" onchange="enviarEstado()">
            <button onclick="resetear()" style="background: #e74c3c; color: white; width: 100%; margin-top: auto;">Reiniciar Partida</button>
        </div>

        <div class="bottom-box glass-effect">
            <h3>üì± Remoto</h3>
            <div id="contenedorQR"></div>
            <p style="font-size: 1.2vh; opacity: 0.8; text-align: center; margin: 5px 0 0 0;">Escanea para controlar esta mesa</p>
        </div>

        <div class="bottom-box glass-effect">
            <h3>üèÜ Top Ranking</h3>
            <div id="ranking" style="text-align: left; width: 100%; font-size: 1.5vh; line-height: 1.5;"></div>
        </div>

        <div class="bottom-box glass-effect">
            <h3>üìà Estad√≠sticas</h3>
            <div id="estadisticas" style="text-align: left; width: 100%; font-size: 1.5vh; line-height: 1.5;"></div>
        </div>
    </div>
</div>

<div class="celebracion" id="celebracion">
    <div id="textoGanador"></div>
    <button onclick="nuevaPartida()" style="font-size: 3vh; padding: 2vh 4vw; border-radius: 50px;">NUEVA PARTIDA</button>
</div>

<script>
// ==========================================
// CONFIGURACI√ìN FIREBASE
// ==========================================
const firebaseConfig = { databaseURL: "https://billares-pepo-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// VARIABLES MULTIMESA
let mesaActual = "1";
let dbRefMesa = null; 

let puntosA = 0, puntosB = 0;
let ranking = {}, estadisticas = {};

// TIMER
let timerInterval; let totalSeconds = 0;
function startTimer() { stopTimer(); totalSeconds = 0; updateTimerDisplay(); timerInterval = setInterval(() => { totalSeconds++; updateTimerDisplay(); }, 1000); }
function stopTimer() { if (timerInterval) clearInterval(timerInterval); }
function resetTimer() { stopTimer(); totalSeconds = 0; updateTimerDisplay(); startTimer(); }
function updateTimerDisplay() {
    const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); const seconds = totalSeconds % 60;
    const format = (num) => String(num).padStart(2, '0');
    if(document.getElementById('timer-display')) document.getElementById('timer-display').textContent = `${format(hours)}:${format(minutes)}:${format(seconds)}`;
}

// ==========================================
// INICIALIZACI√ìN Y L√ìGICA DE RUTEO (TV vs CELULAR)
// ==========================================
const urlParams = new URLSearchParams(window.location.search);
const isRemoto = urlParams.get('modo') === 'remoto';
const mesaRemotaUrl = urlParams.get('mesa') || "1";

window.onload = () => {
    if(isRemoto) {
        document.body.style.backgroundImage = "none";
        document.body.style.backgroundColor = "#111";
        document.getElementById('loginOverlay').style.display = 'none';
        iniciarControlRemoto(mesaRemotaUrl);
    } else {
        mesaActual = localStorage.getItem("mesaGuardada") || "1";
        document.getElementById("mesaInput").value = mesaActual;
    }
};

function iniciarSistema() {
    if(document.getElementById('passInput').value === 'billar2025') {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        
        cargarEstadisticasGlobales();
        cambiarMesa(); 
        startTimer();
    } else { alert("Contrase√±a incorrecta"); }
}

// ==========================================
// L√ìGICA DE TELEVISI√ìN (PANTALLA PRINCIPAL)
// ==========================================
function cargarEstadisticasGlobales() {
    db.ref('datos_jugadores').on('value', (snapshot) => {
        const data = snapshot.val();
        if(data) { ranking = data.ranking || {}; estadisticas = data.estadisticas || {}; renderDatos(); }
    });
}

function cambiarMesa() {
    mesaActual = document.getElementById("mesaInput").value.trim() || "1";
    localStorage.setItem("mesaGuardada", mesaActual);
    
    if(dbRefMesa) dbRefMesa.off();
    dbRefMesa = db.ref('mesas/mesa_' + mesaActual);
    
    dbRefMesa.on('value', (snapshot) => {
        const data = snapshot.val() || { pA: 0, pB: 0, nA: "Jugador 1", nB: "Jugador 2", obj: 40 };
        
        if(data.pA !== puntosA) animarNumero("puntosA");
        if(data.pB !== puntosB) animarNumero("puntosB");
        
        puntosA = data.pA; puntosB = data.pB;
        
        if(document.activeElement !== document.getElementById('nombreA')) document.getElementById('nombreA').value = data.nA || "Jugador 1";
        if(document.activeElement !== document.getElementById('nombreB')) document.getElementById('nombreB').value = data.nB || "Jugador 2";
        if(document.activeElement !== document.getElementById('objetivo')) document.getElementById('objetivo').value = data.obj || 40;
        
        actualizarDOM();
        verificar();
    });

    const qrDiv = document.getElementById("contenedorQR");
    qrDiv.innerHTML = "";
    const urlRemota = window.location.href.split('?')[0] + `?modo=remoto&mesa=${encodeURIComponent(mesaActual)}`;
    new QRCode(qrDiv, { text: urlRemota, width: 100, height: 100 });
}

function enviarEstado() {
    if(!dbRefMesa) return;
    dbRefMesa.set({
        pA: puntosA, pB: puntosB,
        nA: document.getElementById('nombreA').value,
        nB: document.getElementById('nombreB').value,
        obj: document.getElementById('objetivo').value
    });
}

function actualizarDOM() {
    document.getElementById("puntosA").textContent = puntosA;
    document.getElementById("puntosB").textContent = puntosB;
}

function animarNumero(idElemento) {
    const el = document.getElementById(idElemento);
    if(el){ el.classList.remove("animar-punto"); void el.offsetWidth; el.classList.add("animar-punto"); }
}

function sumarA() { puntosA++; enviarEstado(); }
function restarA() { if(puntosA>0) puntosA--; enviarEstado(); }
function sumarB() { puntosB++; enviarEstado(); }
function restarB() { if(puntosB>0) puntosB--; enviarEstado(); }

function verificar() {
    let obj = parseInt(document.getElementById("objetivo").value);
    if(puntosA >= obj) registrarVictoria(document.getElementById('nombreA').value, document.getElementById('nombreB').value, puntosA, puntosB);
    else if(puntosB >= obj) registrarVictoria(document.getElementById('nombreB').value, document.getElementById('nombreA').value, puntosB, puntosA);
}

function registrarVictoria(ganador, perdedor, pG, pP) {
    if(document.getElementById("celebracion").classList.contains("activa")) return;
    stopTimer();

    ranking[ganador] = (ranking[ganador] || 0) + 1;
    if(!estadisticas[ganador]) estadisticas[ganador] = {jugadas:0, puntos:0};
    if(!estadisticas[perdedor]) estadisticas[perdedor] = {jugadas:0, puntos:0};
    
    estadisticas[ganador].jugadas++; estadisticas[ganador].puntos += pG;
    estadisticas[perdedor].jugadas++; estadisticas[perdedor].puntos += pP;
    
    db.ref('datos_jugadores').set({ ranking: ranking, estadisticas: estadisticas });
    
    document.getElementById("textoGanador").innerHTML = "¬°TENEMOS UN CAMPE√ìN!<br><span style='color:white;'>" + ganador + "</span>";
    document.getElementById("celebracion").classList.add("activa");
    lanzarConfetiProfesional();
}

function renderDatos() {
    let r = ""; Object.entries(ranking).sort((a,b)=>b[1]-a[1]).forEach(([n,v],i)=> { let medalla = i===0 ? "ü•á" : i===1 ? "ü•à" : i===2 ? "ü•â" : "üî∏"; r += `<b>${medalla} ${n}</b>: ${v} vict.<br>`; });
    document.getElementById("ranking").innerHTML = r;
    
    let e = ""; for(let j in estadisticas) { let s = estadisticas[j]; let prom = s.jugadas > 0 ? (s.puntos/s.jugadas).toFixed(1) : 0; e += `<b>${j}</b>: ${s.jugadas}P | Prom: ${prom}<br>`; }
    document.getElementById("estadisticas").innerHTML = e;
}

function nuevaPartida() { document.getElementById("celebracion").classList.remove("activa"); resetear(); }
function resetear() { puntosA = 0; puntosB = 0; enviarEstado(); resetTimer(); }


// ==========================================
// L√ìGICA DEL CONTROL REMOTO (CELULAR)
// ==========================================
function iniciarControlRemoto(mesaControlada) {
    document.getElementById('app').style.display = 'flex';
    
    // UI del celular: Ahora incluye Inputs en lugar de textos fijos
    document.getElementById('app').innerHTML = `
        <div style="flex:1; display:flex; flex-direction:column; justify-content:space-evenly; max-width: 500px; margin: auto; width: 100%;">
            <div class="header-box glass-effect">
                <h1 class="titulo" style="font-size: 3vh;">MANDO A DISTANCIA</h1>
                <h2 style="color:white; font-size:2vh; margin:0;">MESA ${mesaControlada}</h2>
            </div>

            <div class="glass-effect" style="padding: 2vh; text-align: center;">
                <input type="text" id="remotoNombreA" class="nombre-input-remoto" value="Jugador 1" onchange="cambiarNombreCelular('nA', this.value)" placeholder="Escribe Nombre J1">
                <button onclick="enviarMando(1,0)" class="btn-remoto">+ PUNTO</button>
                <button class="restar btn-remoto-restar" onclick="enviarMando(-1,0)">- Quitar</button>
            </div>

            <div class="glass-effect" style="padding: 2vh; text-align: center;">
                <input type="text" id="remotoNombreB" class="nombre-input-remoto" value="Jugador 2" onchange="cambiarNombreCelular('nB', this.value)" placeholder="Escribe Nombre J2">
                <button onclick="enviarMando(0,1)" class="btn-remoto">+ PUNTO</button>
                <button class="restar btn-remoto-restar" onclick="enviarMando(0,-1)">- Quitar</button>
            </div>
        </div>`;
    
    // Escuchar cambios de Firebase (por si la TV lo cambia, el cel tambi√©n se actualiza)
    db.ref('mesas/mesa_' + mesaControlada).on('value', snap => {
        const data = snap.val();
        if(data) {
            const inputA = document.getElementById('remotoNombreA');
            const inputB = document.getElementById('remotoNombreB');
            // Solo actualiza si NO estamos escribiendo en el campo en ese momento
            if(inputA && document.activeElement !== inputA) inputA.value = data.nA || "Jugador 1";
            if(inputB && document.activeElement !== inputB) inputB.value = data.nB || "Jugador 2";
        }
    });

    // Enviar cambio de nombre a la base de datos
    window.cambiarNombreCelular = (clave, nuevoNombre) => {
        db.ref('mesas/mesa_' + mesaControlada).update({
            [clave]: nuevoNombre
        });
    };

    // Botones de suma y resta
    window.enviarMando = (sumaA, sumaB) => {
        if(window.navigator.vibrate) window.navigator.vibrate(50);
        db.ref('mesas/mesa_' + mesaControlada).once('value', s => {
            const d = s.val() || {pA:0, pB:0};
            db.ref('mesas/mesa_' + mesaControlada).update({ 
                pA: Math.max(0, d.pA + sumaA), 
                pB: Math.max(0, d.pB + sumaB) 
            });
        });
    };
}

// Confeti
function lanzarConfetiProfesional() {
    var duration = 4000; var animationEnd = Date.now() + duration; var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 10000 };
    function randomInRange(min, max) { return Math.random() * (max - min) + min; }
    var interval = setInterval(function() {
        var timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) return clearInterval(interval);
        var particleCount = 50 * (timeLeft / duration);
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
    }, 250);
}
</script>
</body>
</html>
